name: DevOps Todo CI/CD Pipeline

# ì–¸ì œ ì‹¤í–‰í• ì§€ ì •ì˜
on:
  push: # ëª¨ë“  ë¸Œëœì¹˜ì˜ pushì—ì„œ ì‹¤í–‰
  pull_request:
    branches: [main]

# í™˜ê²½ ë³€ìˆ˜ ì„¤ì •
env:
  DOCKER_BUILDKIT: 1
  COMPOSE_DOCKER_CLI_BUILD: 1

jobs:
  # ë¹Œë“œ ë° í…ŒìŠ¤íŠ¸ ì‘ì—…
  build-and-test:
    name: Build and Test
    runs-on: ubuntu-latest

    steps:
      # 1. ì½”ë“œ ì²´í¬ì•„ì›ƒ
      - name: Checkout code
        uses: actions/checkout@v4

      # 2. Docker ë¹Œë“œ í™˜ê²½ ì„¤ì •
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      # 3. Docker Compose ì„¤ì¹˜ í™•ì¸
      - name: Verify Docker Compose
        run: |
          docker --version
          docker-compose --version

      # 4. í”„ë¡œì íŠ¸ ë¹Œë“œ
      - name: Build with Docker Compose
        run: |
          echo "ğŸš€ Building Docker images..."
          docker-compose build --no-cache

      # 5. ì»¨í…Œì´ë„ˆ ì‹œì‘ ë° í—¬ìŠ¤ì²´í¬
      - name: Start services and health check
        run: |
          echo "ğŸƒâ€â™‚ï¸ Starting services..."
          docker-compose up -d

          echo "â° Waiting for services to be ready..."
          sleep 30

          echo "ğŸ” Checking service health..."
          docker-compose ps

      # 6. ê°„ë‹¨í•œ ì—°ê²° í…ŒìŠ¤íŠ¸
      - name: Test service connectivity
        run: |
          echo "ğŸŒ Testing Nginx proxy..."
          curl -f http://localhost:80 || echo "Frontend connection failed"

          echo "ğŸ”§ Testing backend API..."
          curl -f http://localhost:80/api/health || echo "Backend health check failed"

      # 7. ë¡œê·¸ í™•ì¸ (ì‹¤íŒ¨ ì‹œ ë””ë²„ê¹…ìš©)
      - name: Show logs on failure
        if: failure()
        run: |
          echo "ğŸ“‹ Docker Compose logs:"
          docker-compose logs

      # 8. ì •ë¦¬
      - name: Cleanup
        if: always()
        run: |
          echo "ğŸ§¹ Cleaning up..."
          docker-compose down
          docker system prune -f

  # ë°°í¬ ì‘ì—… (ë©”ì¸ ë¸Œëœì¹˜ì— í‘¸ì‹œëœ ê²½ìš°ì—ë§Œ)
  deploy:
    name: Deploy to Production
    needs: build-and-test
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Deploy notification
        run: |
          echo "ğŸš€ Deploying to production..."
          echo "ğŸ“¦ Commit: ${{ github.sha }}"
          echo "ğŸ‘¤ Author: ${{ github.actor }}"

      # ì‹¤ì œ ë°°í¬ëŠ” ë‚˜ì¤‘ì— AWS ì—°ë™ ì‹œ ì¶”ê°€ ì˜ˆì •
      - name: Simulate deployment
        run: |
          echo "âœ… Deployment completed successfully!"
          echo "ğŸŒ Application is now live!"
